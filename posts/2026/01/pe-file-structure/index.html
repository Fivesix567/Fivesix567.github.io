<!DOCTYPE html>
<html lang="zh-CN" dir="ltr">
<head>
  <!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content=" PE# 可移植性可执行文件。
PE (Portable Executable) 是 Windows 下的可执行文件格式（主要用于.exe, .dll, .sys）,主要使用在32位和64位的Windows操作系统。
硬盘上的 .exe 文件 内存中的进程 (Virtual Memory) &#43;-----------------&#43; &#43;-----------------&#43; | DOS Header | -&gt; | DOS Header | &#43;-----------------&#43; &#43;-----------------&#43; | NT Headers | -&gt; | NT Headers | &#43;-----------------&#43; &#43;-----------------&#43; | Section Table | -&gt; | Section Table | &#43;-----------------&#43; &#43;-----------------&#43; | .text (Code) | -&gt; | .text (Code) | &lt;-- AddressOfEntryPoint 指向这 &#43;-----------------&#43; | (Alignment) | &lt;-- 内存对齐产生的空隙 | .data (Vars) | -&gt; | .data (Vars) | &#43;-----------------&#43; &#43;-----------------&#43;PE 结构自上而下分为 4 个核心部分 ：
">
<meta name="theme-color" media="(prefers-color-scheme: light)" content="#ffffff">
<meta name="theme-color" media="(prefers-color-scheme: dark)" content="#343a40">
<meta name="color-scheme" content="light dark"><meta property="og:url" content="https://Fivesix567.github.io/posts/2026/01/pe-file-structure/">
  <meta property="og:site_name" content="Fivesix&#39;s blog">
  <meta property="og:title" content="PE文件结构">
  <meta property="og:description" content="PE# 可移植性可执行文件。
PE (Portable Executable) 是 Windows 下的可执行文件格式（主要用于.exe, .dll, .sys）,主要使用在32位和64位的Windows操作系统。
硬盘上的 .exe 文件 内存中的进程 (Virtual Memory) &#43;-----------------&#43; &#43;-----------------&#43; | DOS Header | -&gt; | DOS Header | &#43;-----------------&#43; &#43;-----------------&#43; | NT Headers | -&gt; | NT Headers | &#43;-----------------&#43; &#43;-----------------&#43; | Section Table | -&gt; | Section Table | &#43;-----------------&#43; &#43;-----------------&#43; | .text (Code) | -&gt; | .text (Code) | &lt;-- AddressOfEntryPoint 指向这 &#43;-----------------&#43; | (Alignment) | &lt;-- 内存对齐产生的空隙 | .data (Vars) | -&gt; | .data (Vars) | &#43;-----------------&#43; &#43;-----------------&#43;PE 结构自上而下分为 4 个核心部分 ：">
  <meta property="og:locale" content="zh_CN">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2026-01-30T16:06:28+08:00">
    <meta property="article:modified_time" content="2026-01-30T16:06:28+08:00">


  <meta itemprop="name" content="PE文件结构">
  <meta itemprop="description" content="PE# 可移植性可执行文件。
PE (Portable Executable) 是 Windows 下的可执行文件格式（主要用于.exe, .dll, .sys）,主要使用在32位和64位的Windows操作系统。
硬盘上的 .exe 文件 内存中的进程 (Virtual Memory) &#43;-----------------&#43; &#43;-----------------&#43; | DOS Header | -&gt; | DOS Header | &#43;-----------------&#43; &#43;-----------------&#43; | NT Headers | -&gt; | NT Headers | &#43;-----------------&#43; &#43;-----------------&#43; | Section Table | -&gt; | Section Table | &#43;-----------------&#43; &#43;-----------------&#43; | .text (Code) | -&gt; | .text (Code) | &lt;-- AddressOfEntryPoint 指向这 &#43;-----------------&#43; | (Alignment) | &lt;-- 内存对齐产生的空隙 | .data (Vars) | -&gt; | .data (Vars) | &#43;-----------------&#43; &#43;-----------------&#43;PE 结构自上而下分为 4 个核心部分 ：">
  <meta itemprop="datePublished" content="2026-01-30T16:06:28+08:00">
  <meta itemprop="dateModified" content="2026-01-30T16:06:28+08:00">
  <meta itemprop="wordCount" content="2400">

<title>PE文件结构 | Fivesix&#39;s blog</title>
<link rel="icon" href="/favicon.png" >
<link rel="manifest" href="/manifest.json">
<link rel="canonical" href="https://Fivesix567.github.io/posts/2026/01/pe-file-structure/">
<link rel="stylesheet" href="/book.min.d8f79ed853197a024be71c3620a88cc516c48531cb27487af5787b9fec2e1480.css" integrity="sha256-2Pee2FMZegJL5xw2IKiMxRbEhTHLJ0h69Xh7n&#43;wuFIA=" crossorigin="anonymous">


  <script defer src="/fuse.min.js"></script>
  <script defer src="/zh.search.min.a0d58115332626557bf63784370e1a5bc09aba05ee7fa06aaf0e13dfa782e100.js" integrity="sha256-oNWBFTMmJlV79jeENw4aW8CaugXuf6Bqrw4T36eC4QA=" crossorigin="anonymous"></script>



  
</head>
<body dir="ltr" class="book-kind-page book-type-posts">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    
<aside class="book-menu">
  <div class="book-menu-content">
    
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="/"><span>Fivesix&#39;s blog</span>
  </a>
</h2>


<div class="book-search hidden">
  <input id="book-search-input" type="text" 
    placeholder="搜索"
    aria-label="搜索"
    maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>
<script>document.querySelector(".book-search").classList.remove("hidden")</script>






<ul><li><a href="/about/">关于我</a></li></ul>








  
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-2b813d7f3301d6d355367b0b6410c384" class="toggle"  />
    <label for="section-2b813d7f3301d6d355367b0b6410c384" class="flex">
      <a role="button" class="">
        AI</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/ai-security/" class="">
      AI 安全</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5e5821efd250569b7629ef6a7526998b" class="toggle" checked />
    <label for="section-5e5821efd250569b7629ef6a7526998b" class="flex">
      <a role="button" class="">
        免杀&amp;Tip</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-5cbba388fb6021e66a5fd61191b3bbc1" class="toggle"  />
    <label for="section-5cbba388fb6021e66a5fd61191b3bbc1" class="flex">
      <a role="button" class="">
        沙箱绕过</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/delay-execution/" class="">
      延迟执行</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-27225c36f389e9935b09599e45de67bb" class="toggle"  />
    <label for="section-27225c36f389e9935b09599e45de67bb" class="flex">
      <a role="button" class="">
        CobaltStrike</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/cs-dev/" class="">
      Cobaltstrike二开</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/hide-console-window/" class="">
      隐藏控制台窗口</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/windows-add-user/" class="">
      Windows添加用户</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/pe-file-structure/" class="active">
      PE文件结构</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/windows-api-levels/" class="">
      Windows API 调用层级</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/apc-local-injection/" class="">
      APCLocalInjection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/create-thread-injection/" class="">
      CreateThreadInjection</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/local-process-injection/" class="">
      LocalProcessInjection</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b0eac0bda1d9d6d5c075a4b42d2665a8" class="toggle"  />
    <label for="section-b0eac0bda1d9d6d5c075a4b42d2665a8" class="flex">
      <a role="button" class="">
        WebSec</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-0b2de9e9083e920768ff58d4cabf97d4" class="toggle"  />
    <label for="section-0b2de9e9083e920768ff58d4cabf97d4" class="flex">
      <a role="button" class="">
        SQL 注入</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-56060fd95a1c74d77d0aa24143c8911f" class="toggle"  />
    <label for="section-56060fd95a1c74d77d0aa24143c8911f" class="flex">
      <a role="button" class="">
        MySQL 注入</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/mysql-injection/" class="">
      MySQL injection</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-00717153446eda77bbe1277046f077ec" class="toggle"  />
    <label for="section-00717153446eda77bbe1277046f077ec" class="flex">
      <a role="button" class="">
        代码审计</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-332e87fb7c57557ccafb47815fd9b1b1" class="toggle"  />
    <label for="section-332e87fb7c57557ccafb47815fd9b1b1" class="flex">
      <a role="button" class="">
        java</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/java-sql-injection/" class="">
      Sql注入</a>
  

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <input type="checkbox" id="section-b74825716f4fa919ae6770cc84777437" class="toggle"  />
    <label for="section-b74825716f4fa919ae6770cc84777437" class="flex">
      <a role="button" class="">
        生活随笔</a>
      <img src="/icons/chevron-right.svg" class="book-icon" alt="Expand" />
    </label>
  

          
  <ul>
    
  </ul>

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="/posts/2026/01/my-first-post/" class="">
      My First Post</a>
  

        </li>
      
    
  </ul>










<ul><li><a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo 官网</a></li></ul>




</nav>




  <script>(function(){var e=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(){localStorage.setItem("menu.scrollTop",e.scrollTop)}),e.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>



  </div>
</aside>
 

    <div class="book-page">
      <header class="book-header hidden">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="/icons/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <h3>PE文件结构</h3>

  <label for="toc-control">
    
    <img src="/icons/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#dos头">DOS头</a>
      <ul>
        <li><a href="#关键字段详解">关键字段详解</a></li>
        <li><a href="#dos-stub-dos-存根">DOS Stub (DOS 存根)</a></li>
      </ul>
    </li>
    <li><a href="#nt-headers">NT Headers</a>
      <ul>
        <li><a href="#nt-headers-结构-image_nt_headers">NT Headers 结构 (IMAGE_NT_HEADERS)</a></li>
      </ul>
    </li>
    <li><a href="#节表-section-table-区段表区段头">节表 (Section Table) (区段表/区段头)</a>
      <ul>
        <li><a href="#结构体--image_section_header-">结构体 ( IMAGE_SECTION_HEADER )</a></li>
      </ul>
    </li>
    <li><a href="#节数据-section-data区段">节数据 (Section Data)(区段)</a></li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
<article class="markdown book-post">
  <h1>
    PE文件结构
  </h1>
  
  <div class="flex align-center text-small book-post-date">
    <img src="/icons/calendar.svg" class="book-icon" alt="Calendar" />
    <span>2026年01月30日</span>
  </div>



  

  


  <div class="book-post-content markdown-inner"><!-- 在这里开始写你的文章... -->
<h1 id="pe">PE<a class="anchor" href="#pe">#</a></h1>
<p><strong>可移植性可执行文件</strong>。</p>
<p>PE (Portable Executable) 是 Windows 下的可执行文件格式（主要用于.exe, .dll, .sys）,主要使用在32位和64位的Windows操作系统。</p>
<pre tabindex="0"><code>硬盘上的 .exe 文件          内存中的进程 (Virtual Memory)
+-----------------+        +-----------------+
| DOS Header      |   -&gt;   | DOS Header      |
+-----------------+        +-----------------+
| NT Headers      |   -&gt;   | NT Headers      |
+-----------------+        +-----------------+
| Section Table   |   -&gt;   | Section Table   |
+-----------------+        +-----------------+
| .text (Code)    |   -&gt;   | .text (Code)    |  &lt;-- AddressOfEntryPoint 指向这
+-----------------+        |   (Alignment)   |  &lt;-- 内存对齐产生的空隙
| .data (Vars)    |   -&gt;   | .data (Vars)    |
+-----------------+        +-----------------+</code></pre><p>PE 结构自上而下分为 4 个核心部分 ：</p>
<p><img src="./index.assets/image-20260201143426922.png" alt="image-20260201143426922"  />
</p>
<h2 id="dos头">DOS头<a class="anchor" href="#dos%e5%a4%b4">#</a></h2>
<p>DOS 头 ( IMAGE_DOS_HEADER ) 是 PE 文件的第一部分，固定大小为 64 字节 (0x40)。</p>
<p>Microsoft 官方在 Windows SDK 头文件 ( winnt.h ) 中对 DOS 头数据结构的定义：</p>
<div class="highlight"><div style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;">
<table style="border-spacing:0;padding:0;margin:0;border:0;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre tabindex="0" style="color:#f8f8f2;background-color:#282a36;-moz-tab-size:2;-o-tab-size:2;tab-size:2;-webkit-text-size-adjust:none;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#ff79c6">typedef</span> <span style="color:#ff79c6">struct</span> _IMAGE_DOS_HEADER {      <span style="color:#6272a4">// DOS .EXE header
</span></span></span><span style="display:flex;"><span>    WORD   e_magic;                     <span style="color:#6272a4">// [0x00] Magic number (&#34;MZ&#34;)
</span></span></span><span style="display:flex;"><span>    WORD   e_cblp;                      <span style="color:#6272a4">// [0x02] Bytes on last page of file
</span></span></span><span style="display:flex;"><span>    WORD   e_cp;                        <span style="color:#6272a4">// [0x04] Pages in file
</span></span></span><span style="display:flex;"><span>    WORD   e_crlc;                      <span style="color:#6272a4">// [0x06] Relocations
</span></span></span><span style="display:flex;"><span>    WORD   e_cparhdr;                   <span style="color:#6272a4">// [0x08] Size of header in paragraphs
</span></span></span><span style="display:flex;"><span>    WORD   e_minalloc;                  <span style="color:#6272a4">// [0x0A] Minimum extra paragraphs needed
</span></span></span><span style="display:flex;"><span>    WORD   e_maxalloc;                  <span style="color:#6272a4">// [0x0C] Maximum extra paragraphs needed
</span></span></span><span style="display:flex;"><span>    WORD   e_ss;                        <span style="color:#6272a4">// [0x0E] Initial (relative) SS value
</span></span></span><span style="display:flex;"><span>    WORD   e_sp;                        <span style="color:#6272a4">// [0x10] Initial SP value
</span></span></span><span style="display:flex;"><span>    WORD   e_csum;                      <span style="color:#6272a4">// [0x12] Checksum
</span></span></span><span style="display:flex;"><span>    WORD   e_ip;                        <span style="color:#6272a4">// [0x14] Initial IP value
</span></span></span><span style="display:flex;"><span>    WORD   e_cs;                        <span style="color:#6272a4">// [0x16] Initial (relative) CS value
</span></span></span><span style="display:flex;"><span>    WORD   e_lfarlc;                    <span style="color:#6272a4">// [0x18] File address of relocation table
</span></span></span><span style="display:flex;"><span>    WORD   e_ovno;                      <span style="color:#6272a4">// [0x1A] Overlay number
</span></span></span><span style="display:flex;"><span>    WORD   e_res[<span style="color:#bd93f9">4</span>];                    <span style="color:#6272a4">// [0x1C] Reserved words
</span></span></span><span style="display:flex;"><span>    WORD   e_oemid;                     <span style="color:#6272a4">// [0x24] OEM identifier (for e_oeminfo)
</span></span></span><span style="display:flex;"><span>    WORD   e_oeminfo;                   <span style="color:#6272a4">// [0x26] OEM information; e_oemid specific
</span></span></span><span style="display:flex;"><span>    WORD   e_res2[<span style="color:#bd93f9">10</span>];                  <span style="color:#6272a4">// [0x28] Reserved words
</span></span></span><span style="display:flex;"><span>    LONG   e_lfanew;                    <span style="color:#6272a4">// [0x3C] File address of new exe header (PE Header)
</span></span></span><span style="display:flex;"><span>  } IMAGE_DOS_HEADER, <span style="color:#ff79c6">*</span>PIMAGE_DOS_HEADER;</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="关键字段详解">关键字段详解<a class="anchor" href="#%e5%85%b3%e9%94%ae%e5%ad%97%e6%ae%b5%e8%af%a6%e8%a7%a3">#</a></h3>
<ol>
<li>e_magic (0x00 - 0x02)</li>
</ol>
<ul>
<li>
<p>值 : 必须是 0x5A4D 。</p>
</li>
<li>
<p>ASCII : &ldquo;MZ&rdquo;。纪念 Mark Zbikowski（MS-DOS 的设计者之一）。</p>
</li>
<li>
<p>作用 : 操作系统加载文件时会读取前两个字节。如果不是 &ldquo;MZ&rdquo;，直接报错“不是有效的 Win32 应用程序”。</p>
</li>
</ul>
<p><img src="./index.assets/image-20260201152813742.png" alt="image-20260201152813742"  />
</p>
<p>PS：在小端序系统中， 低位字节存储在低地址，高位字节存储在高地址 。当你用十六进制编辑器（Hex Editor）按顺序看文件内容时，你看到的是 4D 5A （也就是 &ldquo;MZ&rdquo;）。但当你用 C 语言把这两个字节读成一个 WORD (整数) 时，CPU 会把它们倒过来组合，还原成 0x5A4D 。</p>
<ol start="2">
<li>
<p>e_res 和 e_res2 (保留字段)</p>
<p>在现代 Windows 中，这些区域完全不被使用，里面的数据通常是 0。</p>
</li>
<li>
<p>e_lfanew (0x3C - 0x40)</p>
<ul>
<li>
<p>位置 : 结构体的最后 4 个字节 (偏移 60)。</p>
</li>
<li>
<p>类型 : LONG (4字节整数)。</p>
</li>
<li>
<p>指向 PE 头 (NT Headers) 的文件偏移量。它是连接 DOS 时代和 Windows 时代的桥梁。Windows 加载器读取 DOS 头后，直接跳到 e_lfanew 指向的位置去读取真正的 PE 头。</p>
</li>
<li>
<p>常见值 : 通常是 0x00000080 或 0x000000E0 ，但这不固定。你可以把它改成 0x40 （紧挨着 DOS 头），也可以改成 0x1000 （隔得很远），只要文件里对应位置有 PE 头就行。</p>
</li>
</ul>
<h3 id="dos-stub-dos-存根">DOS Stub (DOS 存根)<a class="anchor" href="#dos-stub-dos-%e5%ad%98%e6%a0%b9">#</a></h3>
<p>紧跟在 IMAGE_DOS_HEADER 之后， PE Header 之前，有一段代码叫 DOS Stub。</p>
<ul>
<li>
<p>内容 : 这是一段 16 位的汇编代码。</p>
</li>
<li>
<p>作用 : 当你在纯 DOS 环境下（比如 MS-DOS 6.22）运行这个 Windows exe 时，这段代码会被执行。</p>
</li>
<li>
<p>默认行为 : 打印字符串 &ldquo;This program cannot be run in DOS mode.&rdquo; 然后退出。</p>
<p><img src="./index.assets/image-20260201153958751.png" alt="image-20260201153958751"  />
</p>
</li>
</ul>
</li>
</ol>
<h2 id="nt-headers">NT Headers<a class="anchor" href="#nt-headers">#</a></h2>
<h3 id="nt-headers-结构-image_nt_headers">NT Headers 结构 (IMAGE_NT_HEADERS)<a class="anchor" href="#nt-headers-%e7%bb%93%e6%9e%84-image_nt_headers">#</a></h3>
<p>它在内存中通常位于 0xE0 左右（由 DOS 头的 e_lfanew 决定）。它是一个大结构体，里面包含了三个关键部分：</p>
<pre tabindex="0"><code>typedef struct _IMAGE_NT_HEADERS {
    DWORD Signature;                    // [1] 签名 &#34;PE\0\0&#34;
    IMAGE_FILE_HEADER FileHeader;       // [2] 文件头 (物理属性)
    IMAGE_OPTIONAL_HEADER32 OptionalHeader; // [3] 可选头 (逻辑属性)
} IMAGE_NT_HEADERS32, *PIMAGE_NT_HEADERS32;</code></pre><ol>
<li>Signature (签名) - 4字节</li>
</ol>
<ul>
<li>
<p>值 : 0x00004550 (ASCII: &ldquo;PE\0\0&rdquo;)。</p>
</li>
<li>
<p>这是 PE 文件的身份证。Windows 加载器跳到这里，先看这4个字节。如果不是 &ldquo;PE\0\0&rdquo;，系统就认为它不是有效的 PE 文件。</p>
<p><img src="./index.assets/image-20260201155133690.png" alt="image-20260201155133690"  />
</p>
</li>
</ul>
<ol start="2">
<li>
<p>File Header (文件头) - 20字节</p>
<p>包含文件最基本的物理属性。重要字段：</p>
<ul>
<li>
<p>Machine : CPU 架构。 0x014c (x86), 0x8664 (x64)。</p>
</li>
<li>
<p>NumberOfSections : 节的数量（比如 .text, .data, .rdata 加起来有几个）。</p>
</li>
<li>
<p>TimeDateStamp : 编译时间戳。非常有用的溯源信息（虽然可以伪造）。</p>
</li>
<li>
<p>SizeOfOptionalHeader : 后面那个“可选头”的大小。</p>
</li>
<li>
<p>Characteristics : 文件属性标志（是不是 DLL？是不是系统文件？）。</p>
<p><img src="./index.assets/image-20260201155025913.png" alt="image-20260201155025913"  />
</p>
</li>
</ul>
</li>
<li>
<p>Optional Header (可选头) - 大小可变 (x86通常224字节)</p>
</li>
</ol>
<p>名字叫“可选”，它告诉操作系统如何加载和运行这个文件。
重要字段：</p>
<ul>
<li>
<p>AddressOfEntryPoint (OEP) : 程序入口点 RVA。程序跑起来后第一条指令在哪里？就看这里。</p>
<p><img src="./index.assets/image-20260201160655399.png" alt="image-20260201160655399"  />
</p>
</li>
<li>
<p>ImageBase : 建议加载基址。exe 默认是 0x400000 。</p>
</li>
<li>
<p><img src="./index.assets/image-20260201160712288.png" alt="image-20260201160712288"  />
</p>
</li>
<li>
<p>SectionAlignment : 内存对齐大小（通常 4KB）。</p>
</li>
<li>
<p>FileAlignment : 硬盘对齐大小（通常 512字节）十六进制 (0x200)=512字节。</p>
<p><img src="./index.assets/image-20260201160930755.png" alt="image-20260201160930755"  />
</p>
</li>
<li>
<p>DataDirectory[16] : 数据目录表 。这是通往 16 个关键数据结构的“直通车”数组：</p>
<ul>
<li>Index 0: 导出表 (Export Table)</li>
<li>Index 1: 导入表 (Import Table) - 决定了你要调用哪些 DLL。</li>
<li>Index 2: 资源表 (Resource Table) - 图标、光标、菜单。</li>
<li>Index 5: 重定位表 (Relocation Table) - 用于 ASLR。</li>
<li>Index 14: CLR 头 (.NET 程序专用)。</li>
</ul>
</li>
</ul>
<p><img src="./index.assets/image-20260201160740747.png" alt="image-20260201160740747"  />
</p>
<h2 id="节表-section-table-区段表区段头">节表 (Section Table) (区段表/区段头)<a class="anchor" href="#%e8%8a%82%e8%a1%a8-section-table-%e5%8c%ba%e6%ae%b5%e8%a1%a8%e5%8c%ba%e6%ae%b5%e5%a4%b4">#</a></h2>
<h3 id="结构体--image_section_header-">结构体 ( IMAGE_SECTION_HEADER )<a class="anchor" href="#%e7%bb%93%e6%9e%84%e4%bd%93--image_section_header-">#</a></h3>
<pre tabindex="0"><code>typedef struct _IMAGE_SECTION_HEADER {
    BYTE  Name[8];              // [1] 节名 (如 &#34;.text&#34;, &#34;.data&#34;)
    union {
        DWORD PhysicalAddress;
        DWORD VirtualSize;      // [2] 内存中的实际大小 (未对齐)
    } Misc;
    DWORD VirtualAddress;       // [3] 内存中的 RVA (对齐后)
    DWORD SizeOfRawData;        // [4] 硬盘上的大小 (对齐后)
    DWORD PointerToRawData;     // [5] 硬盘上的文件偏移
    DWORD PointerToRelocations; // (obj文件用，exe通常为0)
    DWORD PointerToLinenumbers; // (调试用，通常为0)
    WORD  NumberOfRelocations;  // (obj文件用)
    WORD  NumberOfLinenumbers;  // (调试用)
    DWORD Characteristics;      // [6] 属性 (读/写/执行)
} IMAGE_SECTION_HEADER, *PIMAGE_SECTION_HEADER;</code></pre><p>[1] Name (8字节)</p>
<ul>
<li>节的名字，如 .text , .rdata 。</li>
<li>注意 : 这只是个标记，系统加载器并不真正关心它叫什么。你可以把它改成 .hacker 甚至乱码，程序依然能跑。只要别超过8个字节。</li>
</ul>
<p>[2] VirtualSize (内存大小) vs [4] SizeOfRawData (硬盘大小)
这俩通常不一样，这是检测**“壳”**的重要特征！</p>
<ul>
<li>正常情况 : VirtualSize ≈ SizeOfRawData 。</li>
<li>加壳/压缩 : VirtualSize (比如 1MB) &raquo; SizeOfRawData (比如 100KB)。说明数据在硬盘上是压缩的，加载到内存后会解压变大。</li>
<li>未初始化变量 (.bss) : VirtualSize &gt; 0, SizeOfRawData = 0。说明这块内存在硬盘上不占地儿，但加载到内存要占位。</li>
</ul>
<p>[3] VirtualAddress (内存 RVA)</p>
<ul>
<li>这个节加载到内存后，离 ImageBase 有多远。</li>
<li>必须是 SectionAlignment (0x1000) 的整数倍。</li>
</ul>
<p>[5] PointerToRawData (文件偏移)</p>
<ul>
<li>这个节的内容在 exe 文件里的具体位置（比如从第 1024 字节开始）。</li>
<li>必须是 FileAlignment (0x200) 的整数倍。</li>
</ul>
<p>[6] Characteristics (属性标志)
决定了这个节的权限。由位掩码控制：</p>
<ul>
<li>0x20000000 (IMAGE_SCN_MEM_EXECUTE): 可执行 (代码段必须有)</li>
<li>0x40000000 (IMAGE_SCN_MEM_READ): 可读</li>
<li>0x80000000 (IMAGE_SCN_MEM_WRITE): 可写 (数据段必须有)</li>
</ul>
<h2 id="节数据-section-data区段">节数据 (Section Data)(区段)<a class="anchor" href="#%e8%8a%82%e6%95%b0%e6%8d%ae-section-data%e5%8c%ba%e6%ae%b5">#</a></h2>
<p>这是 PE 文件的主体部分，占用了 90% 以上的体积。它们按照节表的顺序依次排列。</p>
<ul>
<li>节表 (Section Table) ：是 元数据 (Metadata) 。它是一张清单，告诉系统有哪些节，每个节多大，放在哪里，有什么属性（可读/可写/可执行）。</li>
<li>节数据 (Section Data) ：是 实体数据 (Raw Data) 。它是真正存放代码（机器码）、变量、图片资源的地方。</li>
</ul>
<pre tabindex="0"><code>[ PE 文件结构 ]

+-------------------+
| DOS Header        |
+-------------------+
| NT Headers        |
+-------------------+ &lt;--- 1. 节表在这里 (目录)
| Section Table     |      它记录了：
|  - .text Header   | --------+  (指向 .text 的数据位置)
|  - .data Header   | ------+ |
|  - .rsrc Header   | ----+ | |
+-------------------+     | | |
| (Padding)         |     | | |
+===================+     | | |
| Section Data      | &lt;---+ | |
|  - .text Data     |       | |
|    (机器码...)     |       | |
+-------------------+       | |
|  - .data Data     | &lt;-----+ |
|    (全局变量...)   |         |
+-------------------+         |
|  - .rsrc Data     | &lt;-------+
|    (图标/菜单...)  |
+-------------------+</code></pre><p><img src="./index.assets/image-20260201163606333.png" alt="image-20260201163606333"  />
</p>
<p>对于大多数普通的 EXE/DLL，最后一个节（通常是 .rsrc 或 .reloc ）的数据结束后，文件就到头了。</p>
</div>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">
  <div>
  
    <a href="/posts/2026/01/windows-add-user/" class="flex align-center">
      <img src="/icons/backward.svg" class="book-icon" alt="Backward" />
      <span>Windows添加用户</span>
    </a>
  
  </div>
  <div>
  
    <a href="/posts/2026/01/windows-api-levels/" class="flex align-center">
      <span>Windows API 调用层级</span>
      <img src="/icons/forward.svg" class="book-icon" alt="Forward" />
    </a>
  
  </div>
</div>
 
        
  
  <div class="book-comments">

</div>
  
 
        
        
  
  <div class="book-copyright flex justify-center">
    <small>Fivesix&#39;s blog - © 2026 Fivesix567</small>
  </div>
  
 
        
  
  
    <script>(function(){document.querySelectorAll("pre:has(code)").forEach(e=>{e.addEventListener("click",e.focus),e.addEventListener("copy",function(t){if(t.preventDefault(),navigator.clipboard){const t=window.getSelection().toString()||e.textContent;navigator.clipboard.writeText(t)}})})})()</script>
  

      </footer>

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
  
  <aside class="book-toc">
    <div class="book-toc-content">
      
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#dos头">DOS头</a>
      <ul>
        <li><a href="#关键字段详解">关键字段详解</a></li>
        <li><a href="#dos-stub-dos-存根">DOS Stub (DOS 存根)</a></li>
      </ul>
    </li>
    <li><a href="#nt-headers">NT Headers</a>
      <ul>
        <li><a href="#nt-headers-结构-image_nt_headers">NT Headers 结构 (IMAGE_NT_HEADERS)</a></li>
      </ul>
    </li>
    <li><a href="#节表-section-table-区段表区段头">节表 (Section Table) (区段表/区段头)</a>
      <ul>
        <li><a href="#结构体--image_section_header-">结构体 ( IMAGE_SECTION_HEADER )</a></li>
      </ul>
    </li>
    <li><a href="#节数据-section-data区段">节数据 (Section Data)(区段)</a></li>
  </ul>
</nav>



    </div>
  </aside>
  
 
  </main>

  
</body>
</html>




















